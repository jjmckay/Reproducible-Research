---
title: 'Coursera''s Reproducible Research: Peer Assignment 2'
author: "JJMcKay"
date: "Friday, September 12, 2014"
output: html_document
---

##Synopsis

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


##Analysis

We begin to answer our question using the dataset of observed storm events
from the [National Climactic Data Center](http://www.ncdc.noaa.gov/) of the
[National Oceanic Atmospheric Administration](http://www.noaa.gov/). The
dataset and others like it (most broken down by year) are available from
[Storm Events Database](http://www.ncdc.noaa.gov/stormevents/)
at the National Weather Service website. Specific Storm Events Database URLs
used in this anlaysis include:

- [Bulk Download Page](http://www.ncdc.noaa.gov/stormevents/ftp.jsp)
 - [Codebook](http://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/Storm-Data-Export-Format.docx)
 - [README](http://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/README)
 - [Directory of datasets](http://www1.ncdc.noaa.gov/pub/data/swdi/stormevents/csvfiles/)
- [Detailed information on the gathering of this data](http://www.ncdc.noaa.gov/stormevents/pd01016005curr.pdf)
- [Storm Data FAQ Page](http://www.ncdc.noaa.gov/stormevents/faq.jsp)


With the dataset in its current form, there are four primary variable columns
which are relevant to our research questions. They are:

With respect to population health:
- ***fatalities*** : *numeric* - Fatalities. Deaths resulting directly from the
observed storm.
- ***injuries*** : *numeric* - Injuries. Injuries directly resulting directly from
the observed storm.

And with respect to local economies:
- ***propdmg*** : *numeric* - Monetary amount in USD of property damage resulting directly
from theobserved storm.
- ***cropdmg*** : *numeric* - Monetary amount in USD of crop damage resulting directly
from the observed storm.

The local economy variables are themselves modified by a column vector of
multipliers which can be translated into E notation (e.g. 10E6 = 1,000,000)
and multiplied with the monetary damage variables
- ***propdmgexp*** : *numeric* - An exponent of 10, together used to multiply with
**propdmg**
- ***cropdmgexp*** : *numeric* - An exponent of 10, together used to multiply with
**cropdmg**


```{r keepcols}
health.cols <- c("fatalities", "injuries")
econ.cols <- c("propdmg", "cropdmg")
econmult.cols <- c("propdmgexp", "cropdmgexp")
```

The questions to answer are which events have the most impact on public health
and local economy. Using what we are given, we will devise simple model for
evaluating overall health impact by weighting both relevant variables and
adding them. We will do the same with the economy variables.

```{r impactmodelweights}
fatality.weight <- 3/4
injuries.weight <- 1 - fatality.weight

propdmg.weight <- 3/4
cropdmg.weight <- 1 - propdmg.weight
```

The models we use will be:

1. Public Health Impact Value = (`r fatality.weight`) * *fatalities* + (`r injuries.weight`) * *injuries*

2. Local Economy Impact Value = (`r propdmg.weight`) * *property damage* + (`r cropdmg.weight`) * *crop damage*



```{r downloadpreprocess, cache = TRUE}
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
file <- "./data/stormdata.csv.bz2"
dir.create("./data")
download.file(url.zip, file)
sd <- read.csv(bzfile(file), stringsAsFactors = FALSE)

## Restyle column names
colnames(s) <- tolower(colnames(s))
colnames(s) <- gsub("_", ".", colnames(s))
colnames(s)[1] <- "state"




## Add a column with just the year as a factor using bgn.date as a source
#s$year <- factor(strptime(which.max(as.Date(s$bgn.date, format = "%m/%d/%Y %H:%M:%S")), "%Y"))

e <- data.frame(date = as.Date(s$bgn.date, "%m/%d/%Y %H:%M:%S"),
                year = factor(format(as.Date(s$bgn.date, "%m/%d/%Y %H:%M:%S"), format = "%Y")),
                month = factor(format(as.Date(s$bgn.date, "%m/%d/%Y %H:%M:%S"), format = "%b")),
                evtype = factor(tolower(s$evtype)),
                fatalities = s$fatalities,
                injuries = s$injuries,
                fatinj = (0.75) * s$
                propdmg = 
                )
e$date <- as.Date(s$bgn.date, "%m/%d/%Y %H:%M:%S")
e$year <- factor(format(as.Date(s$bgn.date, "%m/%d/%Y %H:%M:%S"), format = "%Y"))
e$month <- factor(format(as.Date(s$bgn.date, "%m/%d/%Y %H:%M:%S"), format = "%b"))


## With the dataset in its current form, there are four variable columns which
## are relevant to our research. They are



## It appears that the data for monetary values was entered in two parts:
## a number and a multiplier. Worse yet, the multiplier which was

table(s$propdmgexp)
table(s$cropdmgexp)
## A glimpse at the tables show us that approximately half of the values were
## entered as-is and the others used a character to denote the place of the
## value (i.e. 'M' or 'm' for millions, 'K' or 'k' for thousands). We can induce
## that the integers represent the exponent of 10 as used in E notation (i.e. )
## for multiplying the value (i.e. 5 represents a multiplyer of 10E5, or
## 10,000). Characters such as '-', '?', and '+' account for less than .002%
## of the property damage data:
round((sum(s$propdmgexp %in% c("-", '?', "+")) / nrow(s)) * 100, digits = 3)
## and less than .001% of the crop damage data:
round((sum(s$cropdmgexp %in% c("-", '?', "+")) / nrow(s)) * 100, digits = 3)
## these values are likely user error and the associated values will be
## considered entered as is.

## Conversion
s$propnumeric()

## Function takes the column (vector) of the raw input multiplier data
## found in propdmgexp and cropdmgexp.

addUpper <- function(lower.chars) {
  return c(lower.chars, toupper(lower.chars))
}

cleanMultCol <- function(raw.col) {
  ## Builds a character vector of the known characters/integers we know how to
  ## interpret.
  ##
  ## Note that we did not add 't' among them as it can stand for either 'tens'
  ## or 'trillions'. Common sense would have us rule out tens as it's so close
  ## to the actual value as to be ignored as a multiplier (although 1 itself is
  ## used as a multiplier a few times). More likely is an event that may cost
  ## trillions, and we need to be able to handle this multiplier in case of a
  ## "mega-event" like a tsunami hitting NYC or Godzilla. Therefore we recommend
  ## the use of the script in the future consider the events using a 't'
  ## mulitplier for the damage values on a case-by-case basis to determine
  ## whether the 't' is used to indicate a 'tens' or 'trillions' mulitplier, or
  ## was simply user error.
  
  ## Presently written to account for both upper and lower case
  hundred <- addUpper(c("h"))
  thousand <- addUpper(c("k"))
  million <- addUpper(c("m"))
  billion <- addUpper(c("b"))
  
  valid.chars <- c(hundred,
                   thousand,
                   million,
                   billion)
  
  
  ## We will do not include 1 since it is more likely the person entered it
  ## thinking it was meant to indicate the "ones' place". It will therefore
  ## be converted to zero along with everything not a valid character or
  ## integer.
  valid.ints <- 2:9
  
  ## Vectors of characters that will be converted to numeric exponential of 10
  ## First we build logical vectors for each int we want in our final column
  ## of multiplier exponents (i.e. 0 and 2 through 9)

  ## Also, this section would need to be modified by increasing the valid range
  ## for conversion beyond 9.
  to0 <- !(raw.col %in% valid.chars | raw.col %in% valid.ints)  

  ## I really didn't want to repeat myself here but the code below (or LOC equal
  ## to it) would more or less have to be written anyway due to the irregularity
  ## of the valid characters to convert from. There's a way no doubt, I'm just
  ## pressed for time to finish and probably am not as skilled in R to code it
  ## off the cuff.
  to2 <- raw.col == 2 | raw.col %in% hundred
  to3 <- raw.col == 3 | raw.col %in% thousand
  to4 <- raw.col == 4
  to5 <- raw.col == 5
  to6 <- raw.col == 6 | raw.col %in% million
  to7 <- raw.col == 7
  to8 <- raw.col == 8
  to9 <- raw.col == 9 | raw.col %in% billion

  cleaned.col[to0] <- 0
  
  for (i in valid.ints) {
    cleaned.col[get(paste0("to",i)] <- i
  }
  
  return cleaned.col
}

```

###Events most harmful with respect to population health?

```{r eventdeathandinjuries}
## Death and injuries totals and averages by event
di.tot <- with(s, aggregate(cbind(fatalities, injuries) ~ evtype, data = s, sum))
di.ave <- with(s, aggregate(cbind(fatalities, injuries) ~ evtype, data = s, mean, na.rm = TRUE))

# head(di[with(di, order(fatalities, injuries, decreasing = TRUE, na.last = NA)), ], 25)
# head(di.ave[with(di.ave, order(fatalities, injuries, decreasing = TRUE, na.last = NA)), ], 25)

t25.di.ave <- head(di.ave[with(di.ave, order(fatalities, injuries, decreasing = TRUE, na.last = NA)), ], 25)
t25.di.tot <- head(di.tot[with(di.tot, order(fatalities, injuries, decreasing = TRUE, na.last = NA)), ], 25)

qplot(di.ave$fatalities)
# ggplot(di.ave, aes(x = evtype, y = fatalities)) + geom_bar(stat = "identity")

```

###Events most harmful with respect to local economy?


```{r eventpropertydamage}
di.tot <- with(s, aggregate(cbind(fatalities, injuries) ~ evtype, data = s, sum))
di.ave <- with(s, aggregate(cbind(fatalities, injuries) ~ evtype, data = s, mean, na.rm = TRUE))

t25.di.ave <- head(di.ave[with(di.ave, order(fatalities, injuries, decreasing = TRUE, na.last = NA)), ], 25)
t25.di.tot <- head(di.tot[with(di.tot, order(fatalities, injuries, decreasing = TRUE, na.last = NA)), ], 25)


```



